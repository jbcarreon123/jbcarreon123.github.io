---
import { loadMusic } from "../assets/loadMusic";
import { fromPath } from '@catamphetamine/id3js/node';

const music = await loadMusic();
---

<script is:inline>
    document.addEventListener("DOMContentLoaded", loadPlayer);
    document.addEventListener("astro:after-swap", loadPlayer);

    function loadPlayer() {
        let audio = document.querySelector('audio#player');

        document.querySelectorAll(".playlist .select").forEach((el) => {
            el.addEventListener("click", (e) => {
                audio.querySelector('source').src = '/music/' + el.dataset.value;
                audio.title = el.dataset.title;
                audio.load();
                audio.play();
                document.querySelector('[data-way="playpause"]').innerHTML = 'pause';
                document.querySelector('.np-container #title').textContent = el.dataset.title;
                document.querySelector('.np-container #artist').textContent = el.dataset.artist;
                document.querySelectorAll(".playlist .select").forEach((el) => {
                    el.classList.remove("selected");
                });
                el.classList.add("selected");
            });
        });

        document.querySelector('.playlist .select').classList.add('selected');
    }

    function changeAudio(el) {
        let audio = document.querySelector('audio#player');
        let tag = document.querySelector(`#player .select.selected`);
        let vals = document.querySelectorAll('.playlist .select');
        let prev = tag.dataset.prevtrack || vals[vals.length - 1].dataset.value;
        let next = tag.dataset.nexttrack || vals[0].dataset.value;
        let prevTag = document.querySelector(`[data-value="${prev}"]`);
        let nextTag = document.querySelector(`[data-value="${next}"]`);

        console.log(el);
        switch (el.dataset.way) {
            case "playpause":
                if (el.innerHTML === 'play_arrow') {
                    audio.play();
                    el.innerHTML = 'pause';
                } else {
                    audio.pause();
                    el.innerHTML = 'play_arrow';
                }
                break;
            case "prev":
                audio.querySelector('source').src = '/music/' + prev;
                audio.load();
                audio.play();
                document.querySelector('[data-way="playpause"]').innerHTML = 'pause';
                document.querySelector('.np-container #title').textContent = prevTag.dataset.title;
                document.querySelector('.np-container #artist').textContent = prevTag.dataset.artist;
                document.querySelectorAll(".playlist .select").forEach((el) => {
                    el.classList.remove("selected");
                });
                prevTag.classList.add("selected");
                break;
            default:
                audio.querySelector('source').src = '/music/' + next;
                audio.load();
                audio.play();
                document.querySelector('[data-way="playpause"]').innerHTML = 'pause';
                document.querySelector('.np-container #title').textContent = nextTag.dataset.title;
                document.querySelector('.np-container #artist').textContent = nextTag.dataset.artist;
                document.querySelectorAll(".playlist .select").forEach((el) => {
                    el.classList.remove("selected");
                });
                nextTag.classList.add("selected");
                break;
        }
    }
</script>

<div class="floating-window" id="player">
    <div class="floating-window-titlebar">
        <p>jPlayer</p>
        <p onclick="closeWindow(this)"><span class="ms">close</span></p>
    </div>
    <div class="floating-window-content">
        <div class="np-container">
            <h2 id="title">{music[0].info?.title}</h2>
            <p id="artist">{music[0].info?.artist}</p>
            <h3 class="controls">
                <span class="ms" data-way="prev" onclick="changeAudio(this)">skip_previous</span>
                <span class="ms" data-way="playpause" onclick="changeAudio(this)">play_arrow</span>
                <span class="ms" data-way="next" onclick="changeAudio(this)">skip_next</span>
            </h3>
        </div>
        <div class="select-container playlist">
            {
                music.map((val) => <div class="select" data-prevtrack={music[music.indexOf(val) - 1]?.name} data-nexttrack={music[music.indexOf(val) + 1]?.name} data-title={val.info?.title} data-artist={val.info?.artist} data-value={val.name}>{val.info?.title} by {val.info?.artist}</div>)
            }
        </div>
        <audio id="player" title={music[0].info?.title} onended="changeAudio(this)">
            <source src={"/music/" + music[0].name} />
        </audio>
    </div>
</div>

<style>
    .playlist {
        grid-template-columns: repeat(1, minmax(6px, 1fr));
        gap:3px;
    }

    .np-container {
        padding: 6px;

        * {
            padding:0;
            margin: 0;
        }
    }

    h3 span.ms {
        cursor: pointer;
    }
</style>
